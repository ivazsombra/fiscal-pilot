# ARCHIVO MAESTRO DE CONTEXTO: PROYECTO SAAS FISCAL

## 1. Objetivo del Proyecto
Desarrollo de un sistema SaaS ("Agente Fiscal") que ingesta documentos legales mexicanos (PDFs de leyes, RMF, Anexos) a una base de datos vectorial para realizar consultas mediante RAG (Retrieval-Augmented Generation).

## 2. Ubicación y Entorno
* **Ruta Raíz:** `E:\Documents\AGENTE FISCAL\saas_fiscal`
* **Carpeta de Datos:** `data/` (Contiene subcarpetas por año: `2022`, `2025`, `2026`).
* **Lenguaje:** Python 3.11 (Entorno virtual `venv` activo).
* **Librerías Clave:** `openai`, `pymupdf` (fitz), `supabase`, `python-dotenv`.

## 3. Arquitectura de Base de Datos (Supabase / PostgreSQL)
El sistema utiliza dos tablas principales vinculadas:

### Tabla: `documents` (Padre)
* `document_id` (Text, PK): Usamos el nombre del archivo sin extensión (ej: "RMF2026").
* `source_filename` (Text): Nombre original del archivo PDF.
* `source_path` (Text): Ruta completa del archivo en disco.
* `title` (Text).

### Tabla: `chunks` (Hija - Vectores)
* `chunk_id` (BigInt, PK, Identity).
* `document_id` (Text, FK): Referencia a `documents.document_id`.
* `text` (Text): El fragmento de contenido legible.
* `embedding` (Vector): Vector generado por OpenAI (`text-embedding-3-small`).
* `metadata` (JSONB): Guarda `chunk_index`, `source`, etc.

## 4. Scripts Críticos y Funcionales

### A. Auditoría (`scr_audit.py`)
* **Función:** Compara los archivos en la carpeta `data` vs. los IDs registrados en la tabla `documents` de Supabase.
* **Salida:** Genera un archivo `lista_para_reprocesar.txt` con los archivos que faltan en la DB.
* **Configuración:** Usa importación modular `from app.core.supabase_client import supabase`.

### B. Procesamiento (`procesar_fallidos.py`)
* **Función:** Lee `lista_para_reprocesar.txt` y sube los archivos faltantes.
* **Características de Seguridad:**
    1.  **Batch Size:** 5 (Para evitar Timeout 57014).
    2.  **Sanitización:** Ejecuta `.replace("\x00", "")` para eliminar Null Bytes que rompen el JSON.
    3.  **Lógica FK:** Inserta primero en `documents` (upsert) antes de subir `chunks`.
    4.  **Reintentos:** Si Supabase da timeout, espera y reintenta el lote hasta 5 veces.

## 5. Solución de Errores Históricos (Lecciones Aprendidas)
1.  **Error 23503 (Foreign Key Violation):** Ocurría al intentar subir chunks sin que existiera el documento padre. *Solución:* Se agregó `upsert` a la tabla `documents` al inicio del loop.
2.  **Error 57014 (Statement Timeout):** Ocurría con lotes grandes (100+). *Solución:* Se redujo el `BATCH_SIZE` a 5.
3.  **Error 201 (JSON could not be generated):** Causado por caracteres ocultos `\x00` en los PDFs. *Solución:* Limpieza de string antes de enviar a DB.
4.  **Error 42703 (Column does not exist):** Confusión entre `id` vs `document_id`. *Solución:* Se estandarizó el uso de `document_id` como PK.

## 6. Estructura Modular del Proyecto
El proyecto no usa credenciales en los scripts, importa la configuración:
```python
import sys
import os
sys.path.append(os.path.dirname(os.path.abspath(__file__)))
from app.core.supabase_client import supabase
==================================================
SESIÓN: 07 Enero 2026
==================================================

### Resumen Técnico
* **Ingesta de Datos (ETL):** Se ejecutó exitosamente el script `procesar_fallidos.py`.
    * Se recuperaron 3 archivos críticos (incluyendo SHCP y Novena Modificación).
    * Se limpiaron caracteres nulos (sanitización UTF-8).
    * Se insertaron 3,723 nuevos embeddings en Supabase sin errores.
* **Lógica del Agente (RAG):** Se detectó un problema de "falsos negativos" por filtrado estricto de fechas (el agente descartaba leyes de 2022 vigentes en 2025).
* **Actualización de Prompt:** Se modificó `services/rag_engine.py` (System Prompt):
    * Se implementó la lógica de "Continuidad Normativa".
    * Se instruyó al agente para usar documentos anteriores si no hay derogación explícita, agregando una nota de advertencia obligatoria.
* **Infraestructura:** Se validó que `main.py` debe contener la instancia de FastAPI. Se realizó el intercambio de archivos antes del despliegue.

### Estado Actual
* Base de datos: Sincronizada y completa (incluyendo archivos grandes).
* Backend: Código actualizado con lógica de continuidad normativa.
* Pendiente: Verificar en producción (Render) que el agente responda correctamente preguntas sobre la "Novena Modificación" usando la nueva lógica.

### Siguiente Paso Exacto
* Realizar el despliegue a Render (`git add .`, `git commit -m "Fix ingesta y update prompt"`, `git push`) y verificar la respuesta del chat en la URL pública.