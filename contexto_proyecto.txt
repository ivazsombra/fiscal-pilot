# ARCHIVO MAESTRO DE CONTEXTO: PROYECTO SAAS FISCAL

## 1. Objetivo del Proyecto
Desarrollo de un sistema SaaS ("Agente Fiscal") que ingesta documentos legales mexicanos (PDFs de leyes, RMF, Anexos) a una base de datos vectorial para realizar consultas mediante RAG (Retrieval-Augmented Generation).

## 2. Ubicación y Entorno
* **Ruta Raíz:** `E:\Documents\AGENTE FISCAL\saas_fiscal`
* **Carpeta de Datos:** `data/` (Contiene subcarpetas por año: `2022`, `2025`, `2026`).
* **Lenguaje:** Python 3.11 (Entorno virtual `venv` activo).
* **Librerías Clave:** `openai`, `pymupdf` (fitz), `supabase`, `python-dotenv`.

## 3. Arquitectura de Base de Datos (Supabase / PostgreSQL)
El sistema utiliza dos tablas principales vinculadas:

### Tabla: `documents` (Padre)
* `document_id` (Text, PK): Usamos el nombre del archivo sin extensión (ej: "RMF2026").
* `source_filename` (Text): Nombre original del archivo PDF.
* `source_path` (Text): Ruta completa del archivo en disco.
* `title` (Text).

### Tabla: `chunks` (Hija - Vectores)
* `chunk_id` (BigInt, PK, Identity).
* `document_id` (Text, FK): Referencia a `documents.document_id`.
* `text` (Text): El fragmento de contenido legible.
* `embedding` (Vector): Vector generado por OpenAI (`text-embedding-3-small`).
* `metadata` (JSONB): Guarda `chunk_index`, `source`, etc.

## 4. Scripts Críticos y Funcionales

### A. Auditoría (`scr_audit.py`)
* **Función:** Compara los archivos en la carpeta `data` vs. los IDs registrados en la tabla `documents` de Supabase.
* **Salida:** Genera un archivo `lista_para_reprocesar.txt` con los archivos que faltan en la DB.
* **Configuración:** Usa importación modular `from app.core.supabase_client import supabase`.

### B. Procesamiento (`procesar_fallidos.py`)
* **Función:** Lee `lista_para_reprocesar.txt` y sube los archivos faltantes.
* **Características de Seguridad:**
    1.  **Batch Size:** 5 (Para evitar Timeout 57014).
    2.  **Sanitización:** Ejecuta `.replace("\x00", "")` para eliminar Null Bytes que rompen el JSON.
    3.  **Lógica FK:** Inserta primero en `documents` (upsert) antes de subir `chunks`.
    4.  **Reintentos:** Si Supabase da timeout, espera y reintenta el lote hasta 5 veces.

## 5. Solución de Errores Históricos (Lecciones Aprendidas)
1.  **Error 23503 (Foreign Key Violation):** Ocurría al intentar subir chunks sin que existiera el documento padre. *Solución:* Se agregó `upsert` a la tabla `documents` al inicio del loop.
2.  **Error 57014 (Statement Timeout):** Ocurría con lotes grandes (100+). *Solución:* Se redujo el `BATCH_SIZE` a 5.
3.  **Error 201 (JSON could not be generated):** Causado por caracteres ocultos `\x00` en los PDFs. *Solución:* Limpieza de string antes de enviar a DB.
4.  **Error 42703 (Column does not exist):** Confusión entre `id` vs `document_id`. *Solución:* Se estandarizó el uso de `document_id` como PK.

## 6. Estructura Modular del Proyecto
El proyecto no usa credenciales en los scripts, importa la configuración:
```python
import sys
import os
sys.path.append(os.path.dirname(os.path.abspath(__file__)))
from app.core.supabase_client import supabase
==================================================
SESIÓN: 07 Enero 2026
==================================================

### Resumen Técnico
* **Ingesta de Datos (ETL):** Se ejecutó exitosamente el script `procesar_fallidos.py`.
    * Se recuperaron 3 archivos críticos (incluyendo SHCP y Novena Modificación).
    * Se limpiaron caracteres nulos (sanitización UTF-8).
    * Se insertaron 3,723 nuevos embeddings en Supabase sin errores.
* **Lógica del Agente (RAG):** Se detectó un problema de "falsos negativos" por filtrado estricto de fechas (el agente descartaba leyes de 2022 vigentes en 2025).
* **Actualización de Prompt:** Se modificó `services/rag_engine.py` (System Prompt):
    * Se implementó la lógica de "Continuidad Normativa".
    * Se instruyó al agente para usar documentos anteriores si no hay derogación explícita, agregando una nota de advertencia obligatoria.
* **Infraestructura:** Se validó que `main.py` debe contener la instancia de FastAPI. Se realizó el intercambio de archivos antes del despliegue.

### Estado Actual
* Base de datos: Sincronizada y completa (incluyendo archivos grandes).
* Backend: Código actualizado con lógica de continuidad normativa.
* Pendiente: Verificar en producción (Render) que el agente responda correctamente preguntas sobre la "Novena Modificación" usando la nueva lógica.

### Siguiente Paso Exacto
* Realizar el despliegue a Render (`git add .`, `git commit -m "Fix ingesta y update prompt"`, `git push`) y verificar la respuesta del chat en la URL pública.
==================================================
SESIÓN: 07 Enero 2026
==================================================

### Resumen Técnico
* **Ingesta de Datos (ETL):** * Se ejecutó `procesar_fallidos.py` exitosamente.
    * Se recuperaron 3 archivos críticos (SHCP y Novena Modificación) limpiando caracteres nulos.
    * Se insertaron 3,723 nuevos embeddings en Supabase.
* **Lógica del Agente (RAG):** * Se modificó el `SYSTEM_PROMPT` en `services/rag_engine.py`.
    * Se implementó lógica de "Continuidad Normativa" para permitir el uso de leyes de 2022/2023 vigentes en 2025/2026, con una nota de advertencia obligatoria.
* **Infraestructura:** * Se validó que `main.py` es la aplicación FastAPI y `test_connection.py` es la prueba simple.
    * Se realizó el commit f08e653 incluyendo scripts de auditoría y reparación.

### Estado Actual
* **Base de datos:** Íntegra y actualizada.
* **Código:** Desplegado en Render (o en proceso tras el push).
* **Pendiente:** Verificar visualmente en el chat web que el agente responde correctamente sobre la "Novena Modificación" sin bloquearse por la fecha.

### Siguiente Paso Exacto
* Entrar a la URL pública del proyecto y realizar la prueba de humo: Preguntar "¿Qué dice la novena modificación del anexo 15?" para confirmar que la nueva lógica de vigencia funciona.
==================================================
SESIÓN: 07 Enero 2026
==================================================

### Resumen Técnico
* **Ingesta de Datos (ETL):**
    * Se ejecutó el script de reparación `procesar_fallidos.py`.
    * Se recuperaron exitosamente archivos críticos (SHCP y Novena Modificación) mediante sanitización UTF-8.
    * Se insertaron 3,723 nuevos embeddings en Supabase.
* **Lógica del Agente (RAG):**
    * Se actualizó `services/rag_engine.py` implementando "Continuidad Normativa".
    * El agente ahora utiliza correctamente documentos de años anteriores (2022) para consultas del ejercicio actual (2025) si siguen vigentes.
* **Infraestructura:**
    * Código desplegado en Render (Commit: "Fix ingesta y update prompt").
    * Validación en producción exitosa: El agente responde con la data correcta.

### Estado Actual
* **Funcionalidad:** ✅ OPERATIVA. El sistema recupera la información correcta y razona bien la vigencia.
* **Bug Detectado:** ⚠️ FORMATO. La respuesta en producción se genera sin espacios entre palabras (ej: "ContextoIdentificado:-**EjercicioFiscal").

### Siguiente Paso Exacto
* Depurar el problema de concatenación de texto (espaciado) en `rag_engine.py` o en la respuesta del endpoint, para que el texto sea legible nuevamente.
Componente,Estado,Detalle Técnico
Infraestructura,OPERATIVA,El servidor corre en Render sobre el puerto 10000.
Interfaz (Frontend),DESPLEGADA,"Se creó la carpeta /static, el archivo index.html y la ruta raíz / sirve la UI correctamente."
Conexión a Base de Datos,EXITOSA,Se corrigió el error de socket local. El backend ya se comunica con el pooler de Supabase vía TCP/IP.
Motor RAG,FUNCIONAL (Básico),"El flujo Pregunta -> Embedding -> Búsqueda -> OpenAI -> Respuesta está activo, pero la recuperación de datos es inconsistente."
Variables de Entorno,CONFIGURADAS,DATABASE_URL y OPENAI_API_KEY están integradas en el panel de Render.
Siguiente Paso Exacto
El siguiente paso es optimizar la calidad de la respuesta y el formato visual. No necesitamos reescribir todo, solo ajustar dos puntos específicos:

1. Mejorar el "Prompt" del Sistema (Backend)
En tu archivo app/services/rag_engine.py, debemos ajustar las instrucciones que recibe GPT-4 para que no sea tan "genérico" y para que, si encuentra información parcial, sepa cómo presentarla mejor.

2. Formateo de Respuesta (Frontend)
Actualmente, el bot responde con texto plano (se ven asteriscos como **). Necesitamos que el index.html interprete Markdown para que las respuestas sean legibles, con negritas, listas y saltos de línea reales.